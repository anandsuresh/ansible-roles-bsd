--------------------------------------------------------------------------------
README
--------------------------------------------------------------------------------
        o
    ____|____
   |         |  Name   : monit
   |  _   _  |  Type   : ansible role
   | [_] [_] |  Group  : app-admin
   |____~____|
    ___//__//   Authors: robomon community
   /|     |/    License: Simplified BSD License
  //|_____|
    _|| ||_     Webpage: http://www.robomon.org/
   (__| |__)
--------------------------------------------------------------------------------
DESCRIPTION
--------------------------------------------------------------------------------

This role manages monit.

Monit is a utility for managing and monitoring processes, files, directories,
devices and network services on a Unix system. Monit conducts automatic
maintenance and repair and can execute meaningful causal actions in error
situations.

monit supports:
 - Daemon mode - poll services at a specified interval
 - Group and manage groups of services, service dependencies
 - Logging - syslog or own logfile
 - Alert, start, stop and restart of services based on it's characteristics
 - MD5 and SHA1 checksums
 - Runtime Unix socket and TCP/IP port checking (tcp and udp)
 - Process status, timeout, memory and cpu usage, etc.
 - Device usage monitoring (inodes and space)
 - File monitoring (timestamp, checksum, permission, owner, etc.)
 - Directory monitoring (timestamp, permission, owner, etc.)
 - Remote network services monitoring (ping, response time, protocol, etc.)
 - System load average monitoring
 - Flexible and customizable email alert messages and notifications
 - Protocol verification such as HTTP, FTP, SMTP, POP, IMAP, NNTP, NTP, etc.
 - A HTTP interface with XML output option

For more detailed information on the usage and available configuration options
please consult the following sections.

--------------------------------------------------------------------------------
USAGE
--------------------------------------------------------------------------------

INSTALL
  - hosts: all
    roles:
     - role: monit
       monit_state: 'install'

ENABLE
  - hosts: all
    roles:
     - role: monit
       monit_state: 'enable'
       monit_mail_server: [{name: {'127.0.0.1'}, port: 25,
                            comment: 'MTA localhost'}]

DISABLE
  - hosts: all
    roles:
     - role: monit
       monit_state: 'disable'
       monit_mail_server: [{name: {'127.0.0.1'}, port: 25,
                            comment: 'MTA localhost'}]

REMOVE
  - hosts: all
    roles:
     - role: monit
       monit_state: 'remove'

INACTIVE
  - hosts: all
    roles:
     - role: monit
       monit_state: 'inactive'

CONFIG
  monit_group_vars:
   - name: 'openssh'
     state: 'true'
     comment: 'OpenSSH'
     config:
      - 'check process openssh with pidfile /run/sshd.pid'
      - '  group system'
      - '  start program = "/sbin/service sshd start"'
      - '  stop program  = "/sbin/service sshd stop"'
      - '  if cpu > 60% for 2 cycles then alert'
      - '  if cpu > 80% for 5 cycles then restart'
      - '  if totalmem > 256.0 MB for 2 cycles then alert'
      - '  if totalmem > 256.0 MB for 5 cycles then restart'
      - '  if failed host 127.0.0.1 port 22 type tcp protocol ssh with timeout 10 seconds then restart'
      - '  if 5 restarts within 5 cycles then timeout'

  monit_host_vars:
   - name: 'pdns-server'
     state: 'true'
     comment: 'PowerDNS Server'
     config:
      - 'check process pdns-server with pidfile /run/pdns.pid'
      - '  group dns'
      - '  start program = "/sbin/service pdns start"'
      - '  stop program  = "/sbin/service pdns stop"'
      - '  if cpu > 60% for 2 cycles then alert'
      - '  if cpu > 80% for 5 cycles then restart'
      - '  if totalmem > 32.0 MB for 2 cycles then alert'
      - '  if totalmem > 32.0 MB for 5 cycles then restart'
      - '  if failed host 127.0.0.1 port 53 type tcp protocol dns then alert'
      - '  if failed host 127.0.0.1 port 53 type udp protocol dns then alert'
      - '  if 5 restarts within 5 cycles then timeout'

   - name: 'pdns-recursor'
     state: 'true'
     comment: 'PowerDNS Recursor'
     config:
      - 'check process pdns-recursor with pidfile /var/lib/powerdns/pdns_recursor.pid'
      - '  group dns'
      - '  start program = "/sbin/service precursor start"'
      - '  stop program  = "/sbin/service precursor stop"'
      - '  if cpu > 60% for 2 cycles then alert'
      - '  if cpu > 80% for 5 cycles then restart'
      - '  if totalmem > 32.0 MB for 2 cycles then alert'
      - '  if totalmem > 32.0 MB for 5 cycles then restart'
      - '  if failed host 127.0.0.1 port 5300 type tcp protocol dns then alert'
      - '  if failed host 127.0.0.1 port 5300 type udp protocol dns then alert'
      - '  if 5 restarts within 5 cycles then timeout'

--------------------------------------------------------------------------------
VARIABLES
--------------------------------------------------------------------------------

CONFIG
  state
    Description: Control the 'state' of the monit file.
    Implemented: 0.1
    Required   : False
    Value      : Predetermined
    Type       : String
    Default    : 'true'
    Options    :
      Create: 'true' | 'yes' | 'create'
      Remove: 'false' | 'no' | 'remove'

  name
    Description: Define the 'name' of the monit file.
                 For more details see 'man monit' or 'monit --help'.
    Implemented: 0.1
    Required   : True
    Value      : Arbitrary
    Type       : String
    Default    : "{{monit_name_default}}"
    Options    :
      Examples: 'openssh' | 'openntpd' | 'opensmtpd' | 'apache' | 'mariadb'

  comment
    Description: Define a 'comment' for the monit file.
    Implemented: 0.1
    Required   : False
    Value      : Arbitrary
    Type       : String
    Default    : ''
    Options    :
      Examples: 'OpenSSH' | 'OpenNTPD' | 'OpenSMTP' | 'Apache HTTP' | 'MariaDB'
      None    : ''

  config
    Description: Define the 'config' entry/entries.
    Implemented: 0.1
    Required   : False
    Value      : Arbitrary
    Type       : Array/Hash
    Default    : []
    Options    :
      Examples: [{name: 'openssh', state: 'true', comment: OpenSSH',
                  config: {'check process openssh with pidfile /run/sshd.pid',
                           'group system',
                           'start program = "/sbin/service sshd start"',
                           'stop program  = "/sbin/service sshd stop"',
                           'if cpu > 60% for 2 cycles then alert',
                           'if cpu > 80% for 5 cycles then restart',
                           'if totalmem > 256.0 MB for 2 cycles then alert',
                           'if totalmem > 256.0 MB for 5 cycles then restart',
                           'if failed host 127.0.0.1 port 22 type tcp protocol ssh with timeout 10 seconds then restart',
                           'if 5 restarts within 5 cycles then timeout'}] |
                [{name: 'apache', state: 'true', comment: Apache HTTP',
                  config: {'check process apache with pidfile /run/apache2.pid',
                           'group web',
                           'start program = "/sbin/service apache2 start"',
                           'stop program  = "/sbin/service apache2 stop"',
                           'if cpu > 60% for 2 cycles then alert',
                           'if cpu > 80% for 5 cycles then restart',
                           'if totalmem > 512.0 MB for 2 cycles then alert',
                           'if totalmem > 512.0 MB for 5 cycles then restart',
                           'if failed host 127.0.0.1 port 80 type tcp protocol http with timeout 10 seconds then restart',
                           'if 5 restarts within 5 cycles then timeout'}]
      None    : []

ROLE
  monit_state
    Description: Control the state of the role.
    Implemented: 0.1
    Required   : False
    Value      : Predetermined
    Type       : String
    Default    : 'enable'
    Options    :
      Install : 'true' | 'yes' | 'install'
      Enable  : 'start' | 'on' | 'enable'
      Disable : 'stop' | 'off' | 'disable'
      Remove  : 'false' | 'no' | 'remove'
      Inactive: 'quiesce' | 'inactive'

  monit_host_vars
    Description: Define the 'monit_host_vars' option.
    Implemented: 0.1
    Required   : False
    Value      : Arbitrary
    Type       : Array/Hash
    Default    : []
    Options    :
      Examples: [{name: 'apache', state: 'true', comment: Apache HTTP',
                  config: {'check process apache with pidfile /run/apache2.pid',
                           'group web',
                           'start program = "/sbin/service apache2 start"',
                           'stop program  = "/sbin/service apache2 stop"',
                           'if cpu > 60% for 2 cycles then alert',
                           'if cpu > 80% for 5 cycles then restart',
                           'if totalmem > 512.0 MB for 2 cycles then alert',
                           'if totalmem > 512.0 MB for 5 cycles then restart',
                           'if failed host 127.0.0.1 port 80 type tcp protocol http with timeout 10 seconds then restart',
                           'if 5 restarts within 5 cycles then timeout'}]
      None    : []

  monit_daemon_delay
    Description: Set the 'monit_daemon_delay' option.
    Implemented: 0.1
    Required   : False
    Value      : Arbitrary
    Type       : Integer, String
    Default    : 3
    Options    :
      Examples: 3 | 5 | 10 | 15 | 20
      None    : ''

  monit_daemon_interval
    Description: Set the 'monit_daemon_interval' option.
    Implemented: 0.1
    Required   : False
    Value      : Arbitrary
    Type       : Integer, String
    Default    : 60
    Options    :
      Examples: 30 | 60 | 120 | 180 | 240 | 300
      None    : ''

  monit_group_vars
    Description: Define the 'monit_group_vars' option.
    Implemented: 0.1
    Required   : False
    Value      : Arbitrary
    Type       : Array/Hash
    Default    : []
    Options    :
      Examples: [{name: 'openssh', state: 'true', comment: OpenSSH',
                  config: {'check process openssh with pidfile /run/sshd.pid',
                           'group system',
                           'start program = "/sbin/service sshd start"',
                           'stop program  = "/sbin/service sshd stop"',
                           'if cpu > 60% for 2 cycles then alert',
                           'if cpu > 80% for 5 cycles then restart',
                           'if totalmem > 256.0 MB for 2 cycles then alert',
                           'if totalmem > 256.0 MB for 5 cycles then restart',
                           'if failed host 127.0.0.1 port 22 type tcp protocol ssh with timeout 10 seconds then restart',
                           'if 5 restarts within 5 cycles then timeout'}]
      None    : []

  monit_include
    Description: Define the 'monit_include' option.
    Implemented: 0.1
    Required   : False
    Value      : Arbitrary
    Type       : String
    Default    :
      FreeBSD: '/usr/local/etc/monit.d/*.cfg'
      Other  : '/etc/monit.d/*.cfg'
    Options    :
      Examples: '/etc/monit.d/*.cfg' | '/usr/local/etc/monit.d/*.cfg'
      None    : ''

  monit_log_facility
    Description: Define the 'monit_log_facility' option.
    Implemented: 0.1
    Required   : False
    Value      : Arbitrary
    Type       : String
    Default    : 'log_daemon'
    Options    :
      Examples: 'log_daemon' | 'user'

  monit_log_file
    Description: Define the 'monit_log_file' option.
    Implemented: 0.1
    Required   : False
    Value      : Arbitrary
    Type       : String
    Default    : 'syslog'
    Options    :
      Examples: 'syslog' | '/var/log/monit/monit.log'

  monit_mail_exclusions
    Description: Define the 'monit_mail_exclusions' option.
    Implemented: 0.1
    Required   : False
    Value      : Arbitrary
    Type       : Array
    Default    : []
    Options    :
      Examples: ['instance', 'action']
      None    : []

  monit_mail_from
    Description: Define the 'monit_mail_from' option.
    Implemented: 0.1
    Required   : False
    Value      : Arbitrary
    Type       : String
    Default    : "monit@{{ansible_domain}}"
    Options    :
      Examples: 'root@domain.tld' | 'admin@domain.tld' | 'user@domain.tld'

  monit_mail_message_action
    Description: Define the 'monit_mail_message_action' option.
    Implemented: 0.1
    Required   : False
    Value      : Arbitrary
    Type       : String
    Default    : '$ACTION'
    Options    :
      Examples: '$ACTION'

  monit_mail_message_date
    Description: Define the 'monit_mail_message_date' option.
    Implemented: 0.1
    Required   : False
    Value      : Arbitrary
    Type       : String
    Default    : '$DATE'
    Options    :
      Examples: '$DATE'

  monit_mail_message_description
    Description: Define the 'monit_mail_message_description' option.
    Implemented: 0.1
    Required   : False
    Value      : Arbitrary
    Type       : String
    Default    : '$DESCRIPTION'
    Options    :
      Examples: '$DESCRIPTION'

  monit_mail_message_event
    Description: Define the 'monit_mail_message_event' option.
    Implemented: 0.1
    Required   : False
    Value      : Arbitrary
    Type       : String
    Default    : '$EVENT'
    Options    :
      Examples: '$EVENT'

  monit_mail_message_host
    Description: Define the 'monit_mail_message_host' option.
    Implemented: 0.1
    Required   : False
    Value      : Arbitrary
    Type       : String
    Default    : '$HOST'
    Options    :
      Examples: '$HOST'

  monit_mail_message_service
    Description: Define the 'monit_mail_message_service' option.
    Implemented: 0.1
    Required   : False
    Value      : Arbitrary
    Type       : String
    Default    : '$SERVICE'
    Options    :
      Examples: '$SERVICE'

  monit_mail_server
    Description: Define the 'monit_mail_server' option.
    Implemented: 0.1
    Required   : False
    Value      : Arbitrary
    Type       : Array/Hash
    Default    : []
    Options    :
      Examples: [{name: {'host01.domain.tld'}, port: 25, comment: 'Primary Mail Server'},
                 {name: {'host02.domain.tld'}, port: 25, comment: 'Secondary Mail Server'}]
      None    : []

  monit_mail_subject
    Description: Define the 'monit_mail_subject' option.
    Implemented: 0.1
    Required   : False
    Value      : Arbitrary
    Type       : String
    Default    : "Monit: $EVENT '$SERVICE' ({{ansible_hostname}})"
    Options    :
      Examples: "Monit: $EVENT '$SERVICE' ({{ansible_hostname}})"

  monit_mail_to
    Description: Define the 'monit_mail_to' option.
    Implemented: 0.1
    Required   : False
    Value      : Arbitrary
    Type       : Array
    Default    : ["admin@{{ansible_domain}}"]
    Options    :
      Examples: ['root@domain.tld'] | ['root@domain.tld', 'admin@domain.tld'] |
                ['root@domain.tld', 'admin@domain.tld', 'user@domain.tld']

  monit_monit_config_template
    Description: Define the template source for 'monit-config.j2'.
                 Any value other than 'main' requires a Jinja2 file to be
                 created. The custom Jinja2 file for an example configuration
                 called 'example' needs to be placed as follows:
                 'monit/templates/example/monit-config.j2'
    Implemented: 0.1
    Required   : False
    Value      : Arbitrary
    Type       : String
    Default    : 'main'
    Options    :
      Examples: 'example' | 'environment' | 'hostname'

  monit_monitrc_template
    Description: Define the template source for 'monitrc.j2'.
                 Any value other than 'main' requires a Jinja2 file to be
                 created. The custom Jinja2 file for an example configuration
                 called 'example' needs to be placed as follows:
                 'monit/templates/example/monitrc.j2'
    Implemented: 0.1
    Required   : False
    Value      : Arbitrary
    Type       : String
    Default    : 'main'
    Options    :
      Examples: 'example' | 'environment' | 'hostname'

  monit_name_default
    Description: Define the 'monit_name_default' option.
    Implemented: 0.1
    Required   : False
    Value      : Arbitrary
    Type       : String
    Default    : ''
    Options    :
      Examples: 'apache' | 'mariadb' | 'postfix'
      None    : ''

  monit_web_server_address
    Description: Define the 'monit_web_server_address' option.
    Implemented: 0.1
    Required   : False
    Value      : Arbitrary
    Type       : String
    Default    : 'localhost'
    Options    :
      Examples: 'localhost'

  monit_web_server_allow
    Description: Define the 'monit_web_server_allow' option.
    Implemented: 0.1
    Required   : False
    Value      : Arbitrary
    Type       : Array/Hash
    Default    : []
    Options    :
      Examples: [{user: 'localhost', comment: 'Allow localhost'}]
      None    : []

  monit_web_server_port
    Description: Set the 'monit_web_server_port' option.
    Implemented: 0.1
    Required   : False
    Value      : Arbitrary
    Type       : Integer, String
    Default    : 2812
    Options    :
      Examples: 2080 | 2812 | 8080

--------------------------------------------------------------------------------
CONFLICTS
--------------------------------------------------------------------------------

ROLES

--------------------------------------------------------------------------------
DEPENDENCIES
--------------------------------------------------------------------------------

PACKAGES
  monit
    Version: >= 5.9
    Name   :
      FreeBSD 10: 'monit'

ROLES

VARIABLES

--------------------------------------------------------------------------------
REQUIREMENTS
--------------------------------------------------------------------------------

CONTROL MACHINE
  Ansible
    Version: >= 1.6

  Python
    Version: >= 2.4

  Python-Crypto
    Version: >= 2.0

  Python-Jinja2
    Version: >= 2.0

  Python-Paramiko
    Version: >= 1.0

  Python-YAML
    Version: >= 3.0

  sshpass
    Version: >= 1.0

MANAGED NODE
  Python
    Version: >= 2.4

--------------------------------------------------------------------------------
SUPPORT
--------------------------------------------------------------------------------

OPERATING SYSTEMS
  FreeBSD
    Version: 10
      Status: Testing

--------------------------------------------------------------------------------
OTHER
--------------------------------------------------------------------------------
